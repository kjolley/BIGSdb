var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Object.is",function(a){return a?a:function(a,c){return a===c?0!==a||1/a===1/c:a!==a&&c!==c}},"es6","es3");
$jscomp.polyfill("Array.prototype.includes",function(a){return a?a:function(a,c){var d=this;d instanceof String&&(d=String(d));var b=d.length;for(c=c||0;c<b;c++)if(d[c]==a||Object.is(d[c],a))return!0;return!1}},"es7","es3");
$jscomp.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};$jscomp.polyfill("String.prototype.includes",function(a){return a?a:function(a,c){return-1!==$jscomp.checkStringArgs(this,a,"includes").indexOf(a,c||0)}},"es6","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var a=0;return function(b){return $jscomp.SYMBOL_PREFIX+(b||"")+a++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");var prefs_loaded,prefs_load_attempts=0,selected_field,selected_type,marker_colour,marker_size;
$(function(){$.ajax({url:prefs_ajax_url}).done(function(a){a=JSON.parse(a);a.height&&(height=a.height);a.segments&&(segments=a.segments);0==a.pie&&(pie=0);theme=a.theme?a.theme:"theme_green";marker_colour=a.marker_colour?a.marker_colour:"marker_red";marker_size=a.marker_size?a.marker_size:2;projection=a.projection?a.projection:"Natural Earth";$("#projection").val(projection);prefs_loaded=1}).fail(function(a){console.log(a)});$('input[name="field_type"][value="fields"]').prop("checked",!0);var a=$("#field").val();
selected_field=a;selected_type=field_types[a];var b=url+"&field="+a,c=is_vertical();get_ajax_prefs();map_fields.includes(a)?load_map_after_prefs_loaded(b,a):"integer"==field_types[a]||"float"==field_types[a]?load_bar(b,a,c):"date"==field_types[a]?load_line(b,a,line):"geography_point"==field_types[a]?load_geography_after_prefs_loaded(b,a):geography_point_lookup_fields.includes(a)?load_geography_after_prefs_loaded(b+"&lookup_coordinates=1",a):load_pie(b,a,segments);$("#field").on("change",function(){$("#bb_chart").css("min-height",
"400px");d3.selectAll("svg").remove();$("div#waiting").css("display","block");$(".bb_controls").css("display","none");$("#geography").css("height",0);$("#geography").html("");var a=is_vertical(),b=$("#field").val();selected_field=b;selected_type=field_types[b];var c=url+"&field="+b;map_fields.includes(b)?load_map(c,b):"integer"==field_types[b]||"float"==field_types[b]?load_bar(c,b,a):"date"==field_types[b]?load_line(c,b,line):"geography_point"==field_types[b]?load_geography(c,b):geography_point_lookup_fields.includes(b)?
load_geography_after_prefs_loaded(c+"&lookup_coordinates=1",b):load_pie(c,b,segments)});$('input[name="field_type"]').on("change",function(){var a=get_field_type();$("#field").empty();$.each({fields:field_list,loci:locus_list,schemes:scheme_list}[a],function(b,c){if("schemes"==a){var d=c.label;b=c.field}else"loci"==a?(b=c,d="undefined"!==typeof locus_labels&&void 0!=locus_labels[c]?locus_labels[c]:c):(d=c.replace(/^.+\.\./,""),b=c);jQuery("<option/>",{value:b,html:d}).appendTo("#field")});$("#field").change();
fasta="loci"==a?1:0});position_controls();$(window).resize(function(){position_controls()});$("#export_image").off("click").click(function(){d3.select("#bb_chart").selectAll("path").attr("fill","none");d3.select("#bb_chart").selectAll("path.domain").attr("stroke","black");d3.select("#bb_chart").selectAll(".tick line").attr("stroke","black");d3.select("#bb_chart").selectAll(".bb-axis-y2").attr("display","none");d3.select("#bb_chart").selectAll(".bb-axis-x").attr("display","none");d3.select("#bb_chart").select(".bb-axis-x").attr("display",
"inline");d3.select("#map").selectAll("path").attr("fill","none");d3.select("#map").selectAll("path").attr("stroke","#444");d3.select("#map").selectAll(".background").attr("fill","none");var a=d3.select("svg").attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML;a=a.replace(/<\/svg>.*$/,"</svg>");a=new Blob([a],{type:"image/svg+xml"});var b=$("#field").val().replace(/^.+\.\./,"")+".svg";saveAs(a,b)});$("#expand_themes").click(function(){$("#themes_shown").toggle();$("#themes_hidden").toggle();
$("#themes_hidden").is(":visible")?$("#expanded_themes").hide(500):$("#expanded_themes").show(500)})});function load_map_after_prefs_loaded(a,b){prefs_load_attempts++;if(!prefs_loaded&&200>prefs_load_attempts)return setTimeout(function(){load_map_after_prefs_loaded(a,b)},50);load_map(a,b)}function load_geography_after_prefs_loaded(a,b){prefs_load_attempts++;if(!prefs_loaded&&200>prefs_load_attempts)return setTimeout(function(){load_geography_after_prefs_loaded(a,b)},50);load_geography(a,b)}
function get_ajax_prefs(){$.ajax({url:prefs_ajax_url+"&loci=1"}).done(function(a){loci=JSON.parse(a)}).fail(function(a){console.log(a)});$.ajax({url:prefs_ajax_url+"&scheme_fields=1"}).done(function(a){schemes=JSON.parse(a)}).fail(function(a){console.log(a)})}function position_controls(){800>$(window).width()?($(".bb_controls").css("position","static"),$(".bb_controls").css("float","left")):($(".bb_controls").css("position","absolute"),$(".bb_controls").css("clear","both"))}
function is_vertical(){return"vertical"==$('input[name="orientation"]').filter(function(){return $(this).prop("checked")}).val()?1:0}function get_field_type(){return $('input[name="field_type"]').filter(function(){return $(this).prop("checked")}).val()}
function load_map(a,b){$("#bar_height").off("slidechange");var c=$("#map").width();$("#bb_chart").html("");var d="country"==b?"iso3":"continent",e="country"==b?"units":"continents",g="country"==b?"/javascript/topojson/countries.json":"/javascript/topojson/continents.json",h={theme_grey:colorbrewer.Greys[5],theme_blue:colorbrewer.Blues[5],theme_green:colorbrewer.Greens[5],theme_purple:colorbrewer.Purples[5],theme_orange:colorbrewer.Oranges[5],theme_red:colorbrewer.Reds[5],theme_blue_green:colorbrewer.BuGn[5],
theme_blue_purple:colorbrewer.BuPu[5],theme_green_blue:colorbrewer.GnBu[5],theme_orange_red:colorbrewer.OrRd[5],theme_purple_blue:colorbrewer.PuBu[5],theme_purple_blue_green:colorbrewer.PuBuGn[5],theme_purple_red:colorbrewer.PuRd[5],theme_red_purple:colorbrewer.RdPu[5],theme_yellow_green:colorbrewer.YlGn[5],theme_yellow_green_blue:colorbrewer.YlGnBu[5],theme_yellow_orange_brown:colorbrewer.YlOrBr[5],theme_yellow_orange_red:colorbrewer.YlOrRd[5]},f={"Azimuthal Equal Area":d3.geoAzimuthalEqualArea,
"Conic Equal Area":d3.geoConicEqualArea,Equirectangular:d3.geoEquirectangular,"Natural Earth":d3.geoNaturalEarth,Mercator:d3.geoMercator,Robinson:d3.geoRobinson,Stereographic:d3.geoStereographic,Times:d3.geoTimes,"Transverse Mercator":d3.geoTransverseMercator,"Winkel tripel":d3.geoWinkel3},m=h[theme];d3.json(a).then(function(k){"country"==b&&(k=merge_terms(k));var l=get_range(k),n=d3.geomap.choropleth().geofile(g).colors(m).column("value").format(d3.format(",d")).legend({width:50,height:120}).projection(f[projection]).duration(1E3).domain([0,
l.recommended]).valueScale(d3.scaleQuantize).unitId(d).units(e).postUpdate(function(){finished_map(a,b)}),p=d3.select("#map").datum(k);n.draw(p);$(window).resize(function(){b===selected_field&&delay(function(){c!=$("#map").width()&&(c=$("#map").width(),$("#map").html(""),load_map(a,b))},500)});$("#colour_range").slider({min:0,max:4,value:l.options.indexOf(l.recommended),slide:function(a,b){n.domain([0,l.options[b.value]]).duration(0).update()}});$(".theme").off("click").click(function(){n.colors(h[this.id]).duration(0).update();
set_prefs("theme",this.id);theme=this.id});$("#projection").off("change").change(function(){d3.selectAll("svg").remove();projection=$("#projection").val();n.projection(f[projection]).draw(p);set_prefs("projection",projection)})})}function merge_terms(a){for(var b={},c=0;c<a.length;c++)b[a[c].iso3]="undefined"==typeof b[a[c].iso3]?a[c].value:b[a[c].iso3]+a[c].value;a=[];var d=Object.keys(b);for(c=0;c<d.length;c++)a.push({iso3:d[c],value:b[d[c]]});return a}
var delay=function(){var a=0;return function(b,c){clearTimeout(a);a=setTimeout(b,c)}}();function get_range(a){var b=a.length;b=parseInt((10<b?.05:.25)*b);for(var c=10,d,e,g=[],h;;){for(var f=[1,2,5],m=0;m<f.length;m++){d=f[m]*c;g.push(d);if(e&&5<=g.length){h=1;break}for(var k=4*d/5,l=0,n=0;n<a.length;n++)a[n].value>=k&&l++;l<=b&&!e&&(e=d)}if(h)break;c*=10;if(1E7<d){e||(e=d);break}}return{recommended:e,options:g.slice(-5)}}
function finished_map(a,b){b===selected_field&&($("div#waiting").css("display","block"),$("#bar_controls").css("display","none"),$("#line_controls").css("display","none"),$("#pie_controls").css("display","none"),$(".transform_to_pie").css("display","inline"),$(".transform_to_donut").css("display","inline"),$(".transform_to_bar").css("display","none"),$(".transform_to_line").css("display","none"),$("#map_controls").css("display","block"),$(".transform_to_donut").off("click").click(function(){$("div#waiting").css("display",
"block");d3.selectAll("svg").remove();load_pie(a,b,segments);pie=0;$("#bb_chart").css("min-height","400px")}),$(".transform_to_pie").off("click").click(function(){$("div#waiting").css("display","block");d3.selectAll("svg").remove();load_pie(a,b,segments);pie=1;$("#bb_chart").css("min-height","400px")}),show_export_options(),$("div#waiting").css("display","none"),$("#bb_chart").css("min-height",0),$(".legend-bg").css("fill","none"))}
function load_pie(a,b,c){$("#bar_controls").css("display","none");$("#line_controls").css("display","none");$("#map_controls").css("display","none");$("#geography_controls").css("display","none");if("undefined"!=typeof b){var d=b.replace(/^.+\.\./,"");"loci"==get_field_type()&&"undefined"!==typeof locus_labels&&void 0!=locus_labels[b]&&(d=locus_labels[b]);d=d.replace(/^s_\d+_/,"");var e=d3.format(".1f");d3.json(a).then(function(g){for(var h=pie_json_to_cols(g,c),f=pie_json_to_cols(g,50),m=0,k=0;k<
f.columns.length;k++)"Others"==f.columns[k][0]&&(m=1);m||f.columns.push(["Others",0]);d+=" ("+h.count+" value"+(1==h.count?"":"s")+")";var l=bb.generate({bindto:"#bb_chart",title:{text:d},data:{columns:f.columns,names:f.names,type:pie?"pie":"donut",order:null,colors:{Others:"#aaa"}},pie:{label:{show:!0},expand:!1},legend:{show:!0,position:"bottom"},size:{height:500},tooltip:{format:{value:function(a,b,c){return a+" ("+e(100*b)+"%)"}}}});l.unload();l.load({columns:h.columns});$("#segments").on("slidechange",
function(){var a=$("#segments").slider("value");$("#segments_display").text(a);segments!=a&&set_prefs("segments",a);segments=a;a=pie_json_to_cols(g,segments);l.unload();l.load({columns:a.columns})});c!=segments&&(h=pie_json_to_cols(g,segments),l.unload(),l.load({columns:h.columns}));$(".transform_to_donut").off("click").click(function(){$(".transform_to_donut").css("display","none");$(".transform_to_pie").css("display","inline");pie=0;set_prefs("pie",0);l.unload();load_pie(a,b,c)});$(".transform_to_pie").off("click").click(function(){$(".transform_to_pie").css("display",
"none");$(".transform_to_donut").css("display","inline");pie=1;set_prefs("pie",1);l.unload();load_pie(a,b,c)});$(".transform_to_map").off("click").click(function(){$(".transform_to_map").css("display","none");load_map(a,b);$(".transform_to_pie").css("display","inline");$(".transform_to_donut").css("display","inline");pie=1;set_prefs("pie",1)});$("#segment_control").css("display","block");$("#segments").slider({min:5,max:50,value:segments});$("#segments_display").text(segments);$(".transform_to_map").css("display",
map_fields.includes(b)?"inline":"none");$(".transform_to_pie").css("display",pie?"none":"inline");$(".transform_to_donut").css("display",pie?"inline":"none");$(".transform_to_bar").css("display","none");$(".transform_to_line").css("display","none");$("#pie_controls").css("display","block");show_export_options();$("div#waiting").css("display","none")},function(a){console.log(a);$("#bb_chart").html('<p style="text-align:center;margin-top:5em"><span class="error_message">Error accessing data.</span></p>')})}}
function pie_json_to_cols(a,b){var c=[],d={},e=[],g=0,h=0,f=0;a.forEach(function(a){a.label=a.label.toString();""==a.label&&(a.label="No value");g++;var k="Data"+g;g>=b?(h+=a.value,f++,g==b&&(e=[a.label,a.value])):c.push([k,a.value]);d[k]=a.label});1==f?c.push(e):1<f&&c.push(["Others",h]);return{columns:c,names:d,count:g}}
function load_line(a,b,c){$("#bar_controls").css("display","none");$("#pie_controls").css("display","none");$("#map_controls").css("display","none");$("#geography_controls").css("display","none");$(".transform_to_map").css("display","none");$("#line_height").off("slidechange");var d=b.replace(/^.+\.\./,"");d3.json(a).then(function(e){remove_null(e);var g=["value"],h=["date"],f=0,m=0;e.forEach(function(a){f++;h.push(a.label);c?(m+=a.value,g.push(m)):g.push(a.value)});d+=" ("+f+" value"+(1==f?"":"s")+
")";var k=bb.generate({bindto:"#bb_chart",title:{text:d},data:{x:"date",columns:[h,g],type:line?"line":"bar",order:"asc"},axis:{x:{type:"timeseries",tick:{format:"%Y-%m-%d",count:100,rotate:90,fit:!0},height:100}},legend:{show:!1}});k.resize({height:height});$(".transform_to_bar").off("click").click(function(){k.unload();load_line(a,b,0);$(".transform_to_bar").css("display","none");$(".transform_to_line").css("display","inline");line=0});$(".transform_to_line").off("click").click(function(){k.unload();
load_line(a,b,1);$(".transform_to_line").css("display","none");$(".transform_to_bar").css("display","inline");line=1});$(".transform_to_line").css("display",line?"none":"inline");$(".transform_to_bar").css("display",line?"inline":"none");$(".transform_to_pie").css("display","none");$(".transform_to_donut").css("display","none");$("#line_controls").css("display","block");$("#line_height").slider({min:300,max:800,value:height});$("#line_height").on("slidechange",function(){height=$("#line_height").slider("value");
k.resize({height:height});set_prefs("height",height)});show_export_options();$("div#waiting").css("display","none")},function(a){console.log(a);$("#bb_chart").html('<p style="text-align:center;margin-top:5em"><span class="error_message">Error accessing data.</span></p>')})}function remove_null(a){$.each(a,function(b,c){"No value"===c.label&&a.splice(b,1)})}
function load_bar_json(a,b,c){remove_null(a);$("#line_controls").css("display","none");$("#pie_controls").css("display","none");$("#map_controls").css("display","none");$("#geography_controls").css("display","none");$("#bar_height").off("slidechange");b=b.replace(/^.+\.\./,"");var d=Object.keys(a).length,e=bb.generate({bindto:"#bb_chart",title:{text:b+(" ("+d+" value"+(1==d?"":"s")+")")},data:{json:a,keys:{x:"label",value:["value"]},type:"bar"},bar:{width:{ratio:.7}},axis:{rotated:c,x:{type:"category",
tick:{culling:!0},height:100}},legend:{show:!1},padding:{right:20}});e.resize({height:height});$("#bar_height").slider({min:300,max:800,value:height});$("#bar_controls").css("display","block");$("#bar_height").on("slidechange",function(){height=$("#bar_height").slider("value");e.resize({height:height});set_prefs("height",height)});show_export_options()}
function load_bar(a,b,c){d3.json(a).then(function(a){load_bar_json(a,b,c);$("div#waiting").css("display","none")},function(a){console.log(a);$("#bb_chart").html('<p style="text-align:center;margin-top:5em"><span class="error_message">Error accessing data.</span></p>')});$('input[name="orientation"]').on("change",function(){var b=$("#field").val();c=is_vertical();load_bar(a,b,c)})}
function load_geography(a,b){$("#bb_chart").html("");$("#geography").css("height","400px");var c=["RoadOnDemand","AerialWithLabelsOnDemand"],d=["Map","Aerial"],e=[];if(bingmaps_api){var g=$("input[name='geography_view']:checked").val(),h;var f=0;for(h=c.length;f<h;++f)e.push(new ol.layer.Tile({visible:d[f]==g?!0:!1,preload:Infinity,source:new ol.source.BingMaps({key:bingmaps_api,imagerySet:c[f]})}))}else e.push(new ol.layer.Tile({source:new ol.source.OSM({crossOrigin:null})}));d3.json(a).then(function(a){var c=
new ol.Map({target:"geography",layers:e,view:new ol.View({center:ol.proj.fromLonLat([0,20]),zoom:2,minZoom:1,maxZoom:16})}),d=get_marker_layer(a);c.addLayer(d);d.getSource().getFeatures().length&&c.getView().fit(d.getSource().getExtent(),{size:c.getSize(),padding:[10,10,10,10],minZoom:2,maxZoom:12,constrainResolution:!1});c.on("postrender",function(f){b===selected_field&&($("#map").html(""),$("div#waiting").css("display","none"),$("#geography_controls").css("display","block"),$("#bb_chart").css("min-height",
0),show_export_options(),$("input[name='geography_view']").off("change").change(function(){"Aerial"==$("input[name='geography_view']:checked").val()?(e[0].setVisible(!1),e[1].setVisible(!0)):(e[0].setVisible(!0),e[1].setVisible(!1));set_prefs("map_style",$("input[name='geography_view']:checked").val())}),$(".marker_colour").off("click").click(function(){set_prefs("marker_colour",this.id);marker_colour=this.id;c.removeLayer(d);d=get_marker_layer(a);c.addLayer(d)}),$("#marker_size").off("slidechange").on("slidechange",
function(){marker_size=$("#marker_size").slider("value");set_prefs("marker_size",marker_size);c.removeLayer(d);d=get_marker_layer(a);c.addLayer(d)}))});$("#marker_size").slider({min:0,max:10,value:marker_size})})}
function get_marker_layer(a){for(var b={marker_red:"rgb(255,0,0,0.7)",marker_blue:"rgb(0,0,255,0.7)",marker_green:"rgb(13,130,58,0.7)",marker_purple:"rgb(176,2,250,0.7)",marker_orange:"rgb(250,85,2,0.7)",marker_yellow:"rgb(252,207,3,0.7)",marker_grey:"rgb(48,48,48,0.7)"},c=[],d=0;10>d;++d){var e=new ol.style.Style({image:new ol.style.Circle({radius:parseInt(marker_size)+d,fill:new ol.style.Fill({color:b[marker_colour]})})});c.push(e)}var g=[1,2,5,10,25,50,100,250,500],h=[];a.forEach(function(a){var b=
a.label.match(/(\-?\d+\.?\d*),\s*(\-?\d+\.?\d*)/);if(null!=b){var d=parseFloat(b[1]);b=parseFloat(b[2]);for(var e,f=0;9>f;++f)if(parseInt(a.value)<=g[f]){e=f;break}null==e&&(e=9);a=new ol.Feature({geometry:new ol.geom.Point(ol.proj.fromLonLat([b,d]))});a.setStyle(c[e]);h.push(a)}});return new ol.layer.Vector({source:new ol.source.Vector({features:h})})}
function show_export_options(){var a=$("#field").val();$("a#export_table").attr("href",url+"&export="+a+"&format=table");$("a#export_excel").attr("href",url+"&export="+a+"&format=xlsx");$("a#export_text").attr("href",url+"&export="+a+"&format=text");$("a#export_fasta").attr("href",url+"&export="+a+"&format=fasta");$("a#export_fasta").css("display",fasta?"inline":"none");$("a#export_image").css("display","geography_point"==selected_type||geography_point_lookup_fields.includes(selected_field)?"none":
"inline");$("#export").css("display","block")}function set_prefs(a,b){$.ajax(prefs_ajax_url+"&update=1&attribute="+a+"&value="+b)};
//# sourceMappingURL=FieldBreakdown.min.js.map
